<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="my-inventory.html">
<link rel="import" href="item-filter.html">

<dom-module id="dim-app">
	<template>
		<my-inventory filter="{{filter}}">
		</my-inventory>
	</template>

	<script>
	Polymer({
		is: "dim-app",
		properties: {
			filter: String,
			normalizedInventory: Object,
			characters: Object,
			weaponTypeSelection: String,
			destinyMembershipType: String,
			destinyMembershipId: String,
			membershipType: String,
			loginStatus: String,
			charInv: Object,
			vaultInv: Object,
			apiKey: {
				type: String,
				value: "17046260b2014770afb509a3e96a1fe2"
			}
		},
		ready: function(){
			var that = this;
			promiseBungled = this.cookieGet("https://www.bungie.net", "bungled");
			promistBungleatk = this.cookieGet("https://www.bungie.net", "bungleatk");

			Q.all([promiseBungled, promistBungleatk])
			.then(function(data){
				return Q(qwest.get("https://www.bungie.net/en/profile"));
			})
			.then(function(xhr){
				var id = /destinyMembershipId: "(.*)"/;
				var type = /membershipType: "(.*)"/;
				var dType = /destinyMembershipType: "(.*)"/;
				that.destinyMembershipId = xhr.response.match(id)[1];
				that.membershipType = xhr.response.match(type)[1];
				that.destinyMembershipType = xhr.response.match(dType)[1];
				var vaultInvUrl = "https://www.bungie.net/Platform/Destiny/" + that.destinyMembershipType + "/Account/" + that.destinyMembershipId + "/";
				return Q(qwest.get(vaultInvUrl, null, {"headers": {"X-API-KEY": that.apiKey}}));
			}, function(){
				that.loginStatus = "NOT LOGGED IN";
			})
			.then(function(xhr){
				that.vaultInv = JSON.parse(xhr.response).Response.data;
				that.characters = that.vaultInv.characters;
				console.log("vault ready");
				var charGetArr = that.buildCharPromises(that.characters);
				return Q.all(charGetArr);
			}, function() {
				// debugger
			})
			.then(function(data){
				that.charInv = _.map(data, function(charXhr){
					var res = JSON.parse(charXhr.response);
					var charInv = res.Response.data;
					charInv.characterId = charXhr.responseURL.match(/Character\/(.*)\/Inventory/)[1];
					return charInv;
				});
				console.log("char ready");
				that.buildInventory();
			})
			.then(function(){
				that.filter = "scout-rifle";
			},function(err){debugger});
		},
		cookieGet: function (url, name){
			var deferred = Q.defer();
			chrome.cookies.get({"url": url, "name": name}, function(cookie){
				deferred.resolve(cookie);
			});
			return deferred.promise;
		},
		buildCharPromises: function (characters) {
			var that = this;
			return _.map(characters, function(character) {
				var charInvUrl = "https://www.bungie.net/Platform/Destiny/" + that.destinyMembershipType + "/Account/" + that.destinyMembershipId + "/Character/" + character.characterBase.characterId + "/Inventory/?definitions=false";
				return Q(qwest.get(charInvUrl, null, {"headers": {"X-API-KEY": that.apiKey}}));
			});
		},
		buildInventory: function() {
			this.buildFromVault();
			this.buildFromChars();
			this.filterInventory();
		},
		filterInventory: function() {
			DIM.inventory = _.omit(DIM.inventory, function(val, key, obj){
				return _.some(DIM.inventoryFilter, function(keyword){
					return key.includes(keyword);
				});
			});
		},
		lookUpTypeName: function(hash){
			return DIM.items[hash].itemTypeName;
		},
		buildFromChars: function(){
			var that = this;
			
			_.each(this.charInv, function(inv){
				var character = _.find(that.characters, function(character){
					return character.characterBase.characterId === inv.characterId;
				});
				that.buildFromBuckets(inv, {name: inv.characterId, icon: character.emblemPath});
			});
		},
		buildFromVault: function(){
			var that = this;
			this.buildFromBuckets(this.vaultInv.inventory, {name: "Vault", icon: "../myicons/vault.png"});
		},
		buildFromBuckets: function(inv, location){
			var that = this;
			var buckets = null;
			if (location.name === "Vault"){
				buckets = inv.buckets.Item;
			} else {
				buckets = inv.buckets.Equippable;
			}
			_.each(buckets, function(bucket) {
				DIM.bucketName = DIM.buckets[bucket.bucketHash].bucketName;
				_.each(bucket.items, function(item) {
					var categoryName = that.lookUpTypeName(item.itemHash);
					var itemClass = DIM.items[item.itemHash].classType;
					var combinedName = "" + categoryName + " " + itemClass;
					if (categoryName.includes("Artifact")){
						var splitName = categoryName.split(" ");
						itemClass = splitName[0];
						categoryName = splitName[1];
					}
					if (categoryName.includes("Bond") || categoryName.includes("Cloak") || categoryName.includes("Mark")){
						categoryName = "Class Armor";
					}
					if (typeof DIM.inventory[categoryName] === "undefined"){
						DIM.inventory[categoryName] = {};
					}
					if (categoryName !== "Artifact"){
						switch(itemClass){
							case 0:
								itemClass = "Titan";
								break;
							case 1:
								itemClass = "Hunter";
								break;
							case 2:
								itemClass = "Warlock";
								break;
							case 3:
								itemClass = "All";
						}
					}
					if (categoryName === "Armsday Order"){
						itemClass = DIM.bucketName;
					}
					if (typeof DIM.inventory[categoryName][itemClass] === "undefined"){
						DIM.inventory[categoryName][itemClass] = [];
					}
					DIM.inventory[categoryName][itemClass].push(that.normalizeItem(item, location));
				});
			});
		},
		normalizeItem: function(vaultItem, location) {
			var archetype = DIM.items[vaultItem.itemHash];
			var normalizedItem = {};
			var classType = archetype.classType;
			var className = "";
			var artifactClass = archetype.itemTypeName.match(/(.*) Artifact/);
			if (artifactClass === null) {
				if (classType === 0){
					className = "Titan";
				} else if (classType === 1) {
					className = "Hunter";
				} else if (classType === 2) {
					className = "Warlock";
				} else if (classType === 3) {
					className = "All";
				}
			} else {
				className = artifactClass[1];
			}
			normalizedItem.klass = className;
			normalizedItem.icon = archetype.icon.match(/common\/destiny_content\/icons\/(.*\..*)/)[1];
			normalizedItem.stats = this.getStat(vaultItem);
			var baseStat = this.getStat(archetype);
			var hStat = _.omit(baseStat, _.keys(normalizedItem.stats));
			baseStat = _.pick(baseStat, _.keys(normalizedItem.stats));
			normalizedItem.baseStat = baseStat;
			hStat = _.omit(hStat, DIM.ignoredStats);
			if (typeof vaultItem.primaryStat !== "undefined"){
				var pStat = DIM.stats[vaultItem.primaryStat.statHash].statName;
				var pVal = vaultItem.primaryStat.value;
				normalizedItem.primaryStat = {};
				normalizedItem.primaryStat[pStat] = pVal;
				hStat = _.omit(hStat, _.keys(normalizedItem.primaryStat));
			}
			normalizedItem.hiddenStats = hStat;
			normalizedItem.name = DIM.items[vaultItem.itemHash].itemName;
			normalizedItem.location = location;
			normalizedItem.talentGrid = this.getTalent(vaultItem);
			normalizedItem.isEquipped = vaultItem.isEquipped;
			normalizedItem.damageType = DIM.damageType[vaultItem.damageType];
			normalizedItem.instanceId = vaultItem.itemInstanceId;
			normalizedItem.itemHash = vaultItem.itemHash;
			normalizedItem.transferStatus = vaultItem.transferStatus;
			return normalizedItem;
		},
		getStat: function(archetype) {
			var friendlyStats = {};
			_.each(archetype.stats, function(stat){
				var name = DIM.stats[stat.statHash].statName;
				var val = stat.value;
				friendlyStats[name] = val;
			});
			return friendlyStats;
		},
		getTalent: function(item){
			var returnGrid = [];
			if (typeof DIM.talents[item.talentGridHash] !== "undefined"){
				var baseGridNodes = DIM.talents[item.talentGridHash].nodes;
				var itemNodes = item.nodes;
				_.each(baseGridNodes, function(node){
					if (node.row >= 0 && node.column >= 0){
						var currentItemNode = _.find(itemNodes, function(itemNode){
							return itemNode.nodeHash === node.nodeHash;
						});
						var step = node.steps[currentItemNode.stepIndex];
						var nodeObj = {};
						nodeObj.name = step.nodeStepName;
						nodeObj.icon = step.icon.match(/common\/destiny_content\/icons\/(.*\..*)/)[1];
						nodeObj.description = step.nodeStepDescription;
						nodeObj.hidden = currentItemNode.hidden;
						nodeObj.isActivated = currentItemNode.isActivated;
						if (typeof returnGrid[node.row] !== "undefined"){
							returnGrid[node.row][node.column] = nodeObj;
						} else {
							returnGrid[node.row] = [];
							returnGrid[node.row][node.column] = nodeObj;
						}
					}
				});
			}
			return returnGrid;
		}
	});
	</script>
</dom-module>