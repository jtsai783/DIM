<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="my-inventory.html">
<link rel="import" href="item-filter.html">

<dom-module id="dim-app">
	<template>
		<item-filter selection="{{weaponTypeSelection}}"></item-filter>
		<br>
		<my-inventory vault-inv="{{vaultInv}}" char-inv="{{charInv}}" filter="{{weaponTypeSelection}}">
		</my-inventory>
		
	</template>

	<script>
	Polymer({
		is: "dim-app",
		properties: {
			characters: Object,
			weaponTypeSelection: String,
			destinyMembershipType: String,
			destinyMembershipId: String,
			membershipType: String,
			loginStatus: String,
			charInv: Object,
			vaultInv: Object,
			apiKey: {
				type: String,
				value: "17046260b2014770afb509a3e96a1fe2"
			}
		},
		ready: function(){
			that = this;
			promiseBungled = this.cookieGet("https://www.bungie.net", "bungled");
			promistBungleatk = this.cookieGet("https://www.bungie.net", "bungleatk");

			Q.all([promiseBungled, promistBungleatk])
			.then(function(data){
				return Q(qwest.get("https://www.bungie.net/en/profile"));
			})
			.then(function(xhr){
				var id = /destinyMembershipId: "(.*)"/;
				var type = /membershipType: "(.*)"/;
				var dType = /destinyMembershipType: "(.*)"/;
				that.destinyMembershipId = xhr.response.match(id)[1];
				that.membershipType = xhr.response.match(type)[1];
				that.destinyMembershipType = xhr.response.match(dType)[1];
				var vaultInvUrl = "https://www.bungie.net/Platform/Destiny/" + that.destinyMembershipType + "/Account/" + that.destinyMembershipId + "/";
				return Q(qwest.get(vaultInvUrl, null, {"headers": {"X-API-KEY": that.apiKey}}));
			}, function(){
				that.loginStatus = "NOT LOGGED IN";
			})
			.then(function(xhr){
				that.vaultInv = JSON.parse(xhr.response);
				that.characters = that.vaultInv.Response.data.characters;
				console.log("vault ready");
				var charGetArr = that.buildCharPromises(that.characters);
				return Q.all(charGetArr);
			}, function() {
				// debugger
			})
			.then(function(data){
				that.charInv = _.map(data, function(charXhr){
					return JSON.parse(charXhr.response).Response.data;
				});
				console.log("char ready");
			});
		},
		cookieGet: function (url, name){
			var deferred = Q.defer();
			chrome.cookies.get({"url": url, "name": name}, function(cookie){
				deferred.resolve(cookie);
			});
			return deferred.promise;
		},
		buildCharPromises: function (characters) {
			return _.map(characters, function(character) {
				var charInvUrl = "https://www.bungie.net/Platform/Destiny/" + that.destinyMembershipType + "/Account/" + that.destinyMembershipId + "/Character/" + character.characterBase.characterId + "/Inventory/?definitions=false";
				return Q(qwest.get(charInvUrl, null, {"headers": {"X-API-KEY": that.apiKey}}));
			});
		}
	});
	</script>
</dom-module>