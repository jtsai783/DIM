<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="item-card.html">
<link rel="import" href="item-filter.html">

<dom-module id="my-inventory">

	<template>
		<item-filter klass="{{classes}}"></item-filter>
		<template is="dom-repeat" items="{{displayitems}}">
			<item-card
				item="{{item}}" 
				maxval="{{chartMaxValue}}"
				maxrow "{{gridMaxRow}}"
				characters="{{characters}}"
			>
			</item-card>
    </template>
	</template>

	<script>
	Polymer({
		is: "my-inventory",
		properties: {
			displayitems: {
				type: Array,
				observer: "onItemsChange"
			},
			chartMaxValue: Number,
			allitems: Array,
			classes: {
				type: Array,
				value: []
			},
			slots: {
				type: Array,
				value: []
			},
			itemready: {
				type: Boolean,
				observer: "invReady"
			}
		},
		invReady: function(){
			_.each(DIM.inventory, function(item){
				if(!_.contains(this.classes, item.klass)){
					this.push("classes", item.klass);
				}
			}, this);
		},
		itemSort: function(a, b){
			return b.stats.Range - a.stats.Range;
		},
		itemFilter: function(item){
			return item.bucket.bucketName === "Leg Armor";
		},
		onItemsChange: function(){
			this.getChartMaxValue();
			this.padPerkGrid();
		},
		getChartMaxValue: function(){
			var maxVal = 0;
			_.each(this.displayitems, function(item){
				var statVal = _.values(item.baseStat)
											.concat(_.values(item.hiddenStats))
											.concat(_.values(item.stats));
				var max = _.max(statVal);
				if (max >= maxVal){
					maxVal = max;
				}
			});
			this.chartMaxValue = maxVal;
		},
		padPerkGrid: function(){
			var maxVal = 0;
			_.each(this.displayitems, function(item){
				if(item.talentGrid.length > maxVal){
					maxVal = item.talentGrid.length;
				}
			});
			
			var padding = {
				padding: true
			};
			this.displayitems = _.map(this.displayitems, function(item){
				if(item.talentGrid.length < maxVal){
					var diff = maxVal - item.talentGrid.length;
					for (i = 0; i < diff; i++) { 
					    item.talentGrid.push([padding]);
					}
				}
				return item;
			});
		}
	});
	</script>
</dom-module>