<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="item-card.html">

<dom-module id="my-inventory">

	<template>
		<template is="dom-repeat" items="{{displayItems}}"  sort="itemSort">
			<item-card item="{{item}}" maxval="{{chartMaxValue}}" maxrow "{{gridMaxRow}}"></item-card>
    </template>
	</template>

	<script>
	Polymer({
		is: "my-inventory",
		properties: {
			filter: {
				type: String,
				observer: "onFilterChange"
			},
			displayItems: Array,
			chartMaxValue: Number
		},
		itemSort: function(a, b){
			return b.stats.Range - a.stats.Range;
		},
		onFilterChange: function(newVal, oldVal){
			var mapping = DIM.filterMapping[newVal];
			var items = DIM.inventory;
			_.each(mapping, function(el, index){
				items = items[el];
			});
			this.displayItems = items;
			this.getChartMaxValue();
			this.padPerkGrid();
		},
		getChartMaxValue: function(){
			var maxVal = 0;
			_.each(this.displayItems, function(item){
				var statVal = _.values(item.baseStat)
											.concat(_.values(item.hiddenStats))
											.concat(_.values(item.stats));
				var max = _.max(statVal);
				if (max >= maxVal){
					maxVal = max;
				}
			});
			this.chartMaxValue = maxVal;
		},
		padPerkGrid: function(){
			var maxVal = 0;
			_.each(this.displayItems, function(item){
				if(item.talentGrid.length > maxVal){
					maxVal = item.talentGrid.length;
				}
			});
			
			var padding = {
				padding: true
			};
			this.displayItems = _.map(this.displayItems, function(item){
				if(item.talentGrid.length < maxVal){
					var diff = maxVal - item.talentGrid.length;
					for (i = 0; i < diff; i++) { 
					    item.talentGrid.push([padding]);
					}
				}
				return item;
			});
		}
	});
	</script>
</dom-module>